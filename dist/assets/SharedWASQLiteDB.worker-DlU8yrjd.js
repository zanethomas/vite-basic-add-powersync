let qn,In,An,On,kn,Ln,Qn,Un,Bn,Cn,Pn,Rn,Nn,vn,xn,Fn,Dn,Wn,Hn;let __tla=(async()=>{In=0;Ln=5;qn=10;An=12;On=14;Qn=3850;xn=522;Nn=1;Rn=4;vn=8;kn=0;Cn=1;Un=2;Pn=3;Bn=4;Dn=512;Wn=1024;Hn=2048;Fn=16384;typeof BigInt.prototype.toJSON>"u"&&(BigInt.prototype.toJSON=function(){return this.toString()});const F=0x7fffffffffffffffn,z=-0x8000000000000000n;class q extends Error{constructor(n,i){super(n),this.code=i}}const Q=!0,V={};globalThis.__onTablesChanged=function(e,n,i,h){setTimeout(()=>V[e]?.(n,i,h),0)};function nn(e){const n={},i=e._getSqliteFree(),h=e._malloc(8),a=[h,h+4];function p(s){if(typeof s!="string")return 0;const r=e.lengthBytesUTF8(s),t=e._sqlite3_malloc(r+1);return e.stringToUTF8(s,t,r+1),t}function m(s,r){return BigInt(r)<<32n|BigInt(s)&4294967295n}const g=function(){const s=BigInt(Number.MAX_SAFE_INTEGER)>>32n,r=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(t,c){return c>s||c<r?m(t,c):c*4294967296+(t&2147483647)-(t&2147483648)}}(),b=new Set;function E(s){if(!b.has(s))throw new q("not a database",21)}const f=new Map;function l(s){if(!f.has(s))throw new q("not a statement",21)}n.bind_collection=function(s,r){l(s);const t=Array.isArray(r),c=n.bind_parameter_count(s);for(let o=1;o<=c;++o){const u=t?o-1:n.bind_parameter_name(s,o),w=r[u];w!==void 0&&n.bind(s,o,w)}return 0},n.bind=function(s,r,t){switch(l(s),typeof t){case"number":return t===(t|0)?n.bind_int(s,r,t):n.bind_double(s,r,t);case"string":return n.bind_text(s,r,t);default:return t instanceof Uint8Array||Array.isArray(t)?n.bind_blob(s,r,t):t===null?n.bind_null(s,r):typeof t=="bigint"?n.bind_int64(s,r,t):t===void 0?27:(console.warn("unknown binding converted to null",t),n.bind_null(s,r))}},n.bind_blob=function(){const s="sqlite3_bind_blob",r=e.cwrap(s,..._("nnnnn:n"));return function(t,c,o){l(t);const u=o.byteLength??o.length,w=e._sqlite3_malloc(u);e.HEAPU8.subarray(w).set(o);const S=r(t,c,w,u,i);return d(s,S,f.get(t))}}(),n.bind_parameter_count=function(){const r=e.cwrap("sqlite3_bind_parameter_count",..._("n:n"));return function(t){return l(t),r(t)}}(),n.bind_double=function(){const s="sqlite3_bind_double",r=e.cwrap(s,..._("nnn:n"));return function(t,c,o){l(t);const u=r(t,c,o);return d(s,u,f.get(t))}}(),n.bind_int=function(){const s="sqlite3_bind_int",r=e.cwrap(s,..._("nnn:n"));return function(t,c,o){if(l(t),o>2147483647||o<-2147483648)return 25;const u=r(t,c,o);return d(s,u,f.get(t))}}(),n.bind_int64=function(){const s="sqlite3_bind_int64",r=e.cwrap(s,..._("nnnn:n"));return function(t,c,o){if(l(t),o>F||o<z)return 25;const u=o&4294967295n,w=o>>32n,S=r(t,c,Number(u),Number(w));return d(s,S,f.get(t))}}(),n.bind_null=function(){const s="sqlite3_bind_null",r=e.cwrap(s,..._("nn:n"));return function(t,c){l(t);const o=r(t,c);return d(s,o,f.get(t))}}(),n.bind_parameter_name=function(){const r=e.cwrap("sqlite3_bind_parameter_name",..._("n:s"));return function(t,c){return l(t),r(t,c)}}(),n.bind_text=function(){const s="sqlite3_bind_text",r=e.cwrap(s,..._("nnnnn:n"));return function(t,c,o){l(t);const u=p(o),w=r(t,c,u,-1,i);return d(s,w,f.get(t))}}(),n.changes=function(){const r=e.cwrap("sqlite3_changes",..._("n:n"));return function(t){return E(t),r(t)}}(),n.last_insert_id=function(){const r=e.cwrap("sqlite3_last_insert_rowid",..._("n:n"));return function(t){return E(t),r(t)}}(),n.close=function(){const s="sqlite3_close",r=e.cwrap(s,..._("n:n"),{async:Q});return async function(t){E(t);const c=await r(t);return b.delete(t),d(s,c,t)}}(),n.column=function(s,r){l(s);const t=n.column_type(s,r);switch(t){case 4:return n.column_blob(s,r);case 2:return n.column_double(s,r);case 1:const c=n.column_int(s,r),o=e.getTempRet0();return g(c,o);case 5:return null;case 3:return n.column_text(s,r);default:throw new q("unknown type",t)}},n.column_blob=function(){const r=e.cwrap("sqlite3_column_blob",..._("nn:n"));return function(t,c){l(t);const o=n.column_bytes(t,c),u=r(t,c);return e.HEAPU8.subarray(u,u+o)}}(),n.column_bytes=function(){const r=e.cwrap("sqlite3_column_bytes",..._("nn:n"));return function(t,c){return l(t),r(t,c)}}(),n.column_count=function(){const r=e.cwrap("sqlite3_column_count",..._("n:n"));return function(t){return l(t),r(t)}}(),n.column_double=function(){const r=e.cwrap("sqlite3_column_double",..._("nn:n"));return function(t,c){return l(t),r(t,c)}}(),n.column_int=function(){const r=e.cwrap("sqlite3_column_int64",..._("nn:n"));return function(t,c){return l(t),r(t,c)}}(),n.column_int64=function(){const r=e.cwrap("sqlite3_column_int64",..._("nn:n"));return function(t,c){l(t);const o=r(t,c),u=e.getTempRet0();return m(o,u)}}(),n.column_name=function(){const r=e.cwrap("sqlite3_column_name",..._("nn:s"));return function(t,c){return l(t),r(t,c)}}(),n.column_names=function(s){const r=[],t=n.column_count(s);for(let c=0;c<t;++c)r.push(n.column_name(s,c));return r},n.column_text=function(){const r=e.cwrap("sqlite3_column_text",..._("nn:s"));return function(t,c){return l(t),r(t,c)}}(),n.column_type=function(){const r=e.cwrap("sqlite3_column_type",..._("nn:n"));return function(t,c){return l(t),r(t,c)}}(),n.create_function=function(s,r,t,c,o,u,w,S){if(E(s),u&&!w&&!S){const I=e.createFunction(s,r,t,c,o,u);return d("sqlite3_create_function",I,s)}if(!u&&w&&S){const I=e.createAggregate(s,r,t,c,o,w,S);return d("sqlite3_create_function",I,s)}throw new q("invalid function combination",21)},n.create_module=function(s,r,t,c){E(s);const o=e.createModule(s,r,t,c);return d("sqlite3_create_module",o,s)},n.data_count=function(){const r=e.cwrap("sqlite3_data_count",..._("n:n"));return function(t){return l(t),r(t)}}(),n.declare_vtab=function(){const r=e.cwrap("sqlite3_declare_vtab",..._("ns:n"));return function(t,c){const o=r(t,c);return d("sqlite3_declare_vtab",o)}}(),n.exec=async function(s,r,t){for await(const c of n.statements(s,r)){let o;for(;await n.step(c)===100;)if(t){o=o??n.column_names(c);const u=n.row(c);await t(u,o)}}return 0},n.finalize=function(){const r=e.cwrap("sqlite3_finalize",..._("n:n"),{async:Q});return async function(t){if(!f.has(t))return 21;const c=await r(t);return f.get(t),f.delete(t),c}}(),n.get_autocommit=function(){const r=e.cwrap("sqlite3_get_autocommit",..._("n:n"));return function(t){return r(t)}}(),n.libversion=function(){const r=e.cwrap("sqlite3_libversion",..._(":s"));return function(){return r()}}(),n.libversion_number=function(){const r=e.cwrap("sqlite3_libversion_number",..._(":n"));return function(){return r()}}(),n.limit=function(){const r=e.cwrap("sqlite3_limit",..._("nnn:n"));return function(t,c,o){return r(t,c,o)}}(),n.open_v2=function(){const s="sqlite3_open_v2",r=e.cwrap(s,..._("snnn:n"),{async:Q});return async function(t,c,o){c=c||6,o=p(o),e.ccall("setup_powersync","int",[]);const u=await r(t,a[0],c,o),w=e.getValue(a[0],"*");return b.add(w),e._sqlite3_free(o),e.ccall("RegisterExtensionFunctions","void",["number"],[w]),d(s,u),w}}(),n.register_table_onchange_hook=function(s,r){e.ccall("register_table_update_hook","int",["number"],[s]),V[s]=function(t,c,o){const u=new DataView(e.HEAPU8.buffer);let w=0;for(;u.getUint8(c+w)!==0;)w++;const S=new Uint8Array(e.HEAPU8.buffer,c,w),I=new TextDecoder().decode(S);return r(t,I,o)}},n.prepare_v2=function(){const s="sqlite3_prepare_v2",r=e.cwrap(s,..._("nnnnn:n"),{async:Q});return async function(t,c){const o=await r(t,c,-1,a[0],a[1]);d(s,o,t);const u=e.getValue(a[0],"*");return u?(f.set(u,t),{stmt:u,sql:e.getValue(a[1],"*")}):null}}(),n.progress_handler=function(s,r,t,c){E(s),e.progressHandler(s,r,t,c)},n.reset=function(){const s="sqlite3_reset",r=e.cwrap(s,..._("n:n"),{async:Q});return async function(t){l(t);const c=await r(t);return d(s,c,f.get(t))}}(),n.result=function(s,r){switch(typeof r){case"number":r===(r|0)?n.result_int(s,r):n.result_double(s,r);break;case"string":n.result_text(s,r);break;default:if(r instanceof Uint8Array||Array.isArray(r))n.result_blob(s,r);else if(r===null)n.result_null(s);else{if(typeof r=="bigint")return n.result_int64(s,r);console.warn("unknown result converted to null",r),n.result_null(s)}break}},n.result_blob=function(){const r=e.cwrap("sqlite3_result_blob",..._("nnnn:n"));return function(t,c){const o=c.byteLength??c.length,u=e._sqlite3_malloc(o);e.HEAPU8.subarray(u).set(c),r(t,u,o,i)}}(),n.result_double=function(){const r=e.cwrap("sqlite3_result_double",..._("nn:n"));return function(t,c){r(t,c)}}(),n.result_int=function(){const r=e.cwrap("sqlite3_result_int",..._("nn:n"));return function(t,c){r(t,c)}}(),n.result_int64=function(){const r=e.cwrap("sqlite3_result_int64",..._("nnn:n"));return function(t,c){if(c>F||c<z)return 25;const o=c&4294967295n,u=c>>32n;r(t,Number(o),Number(u))}}(),n.result_null=function(){const r=e.cwrap("sqlite3_result_null",..._("n:n"));return function(t){r(t)}}(),n.result_text=function(){const r=e.cwrap("sqlite3_result_text",..._("nnnn:n"));return function(t,c){const o=p(c);r(t,o,-1,i)}}(),n.row=function(s){const r=[],t=n.data_count(s);for(let c=0;c<t;++c){const o=n.column(s,c);r.push(o?.buffer===e.HEAPU8.buffer?o.slice():o)}return r},n.set_authorizer=function(s,r,t){E(s);const c=e.setAuthorizer(s,r,t);return d("sqlite3_set_authorizer",c,s)},n.sql=function(){const r=e.cwrap("sqlite3_sql",..._("n:s"));return function(t){return l(t),r(t)}}(),n.statements=function(s,r){return async function*(){const t=n.str_new(s,r);let c={stmt:null,sql:n.str_value(t)};try{for(;c=await n.prepare_v2(s,c.sql);)yield c.stmt,n.finalize(c.stmt),c.stmt=null}finally{c?.stmt&&n.finalize(c.stmt),n.str_finish(t)}}()},n.step=function(){const s="sqlite3_step",r=e.cwrap(s,..._("n:n"),{async:Q});return async function(t){l(t);const c=await r(t);return d(s,c,f.get(t),[100,101])}}();let y=0;const T=new Map;n.str_new=function(s,r=""){const t=e.lengthBytesUTF8(r),c=y++&4294967295,o={offset:e._sqlite3_malloc(t+1),bytes:t};return T.set(c,o),e.stringToUTF8(r,o.offset,o.bytes+1),c},n.str_appendall=function(s,r){if(!T.has(s))throw new q("not a string",21);const t=T.get(s),c=e.lengthBytesUTF8(r),o=t.bytes+c,u=e._sqlite3_malloc(o+1);e.HEAPU8.subarray(u,u+o+1).set(e.HEAPU8.subarray(t.offset,t.offset+t.bytes)),e.stringToUTF8(r,u+t.bytes,c+1),e._sqlite3_free(t.offset),t.offset=u,t.bytes=o,T.set(s,t)},n.str_finish=function(s){if(!T.has(s))throw new q("not a string",21);const r=T.get(s);T.delete(s),e._sqlite3_free(r.offset)},n.str_value=function(s){if(!T.has(s))throw new q("not a string",21);return T.get(s).offset},n.user_data=function(s){return e.getFunctionUserData(s)},n.value=function(s){const r=n.value_type(s);switch(r){case 4:return n.value_blob(s);case 2:return n.value_double(s);case 1:const t=n.value_int(s),c=e.getTempRet0();return g(t,c);case 5:return null;case 3:return n.value_text(s);default:throw new q("unknown type",r)}},n.value_blob=function(){const r=e.cwrap("sqlite3_value_blob",..._("n:n"));return function(t){const c=n.value_bytes(t),o=r(t);return e.HEAPU8.subarray(o,o+c)}}(),n.value_bytes=function(){const r=e.cwrap("sqlite3_value_bytes",..._("n:n"));return function(t){return r(t)}}(),n.value_double=function(){const r=e.cwrap("sqlite3_value_double",..._("n:n"));return function(t){return r(t)}}(),n.value_int=function(){const r=e.cwrap("sqlite3_value_int64",..._("n:n"));return function(t){return r(t)}}(),n.value_int64=function(){const r=e.cwrap("sqlite3_value_int64",..._("n:n"));return function(t){const c=r(t),o=e.getTempRet0();return m(c,o)}}(),n.value_text=function(){const r=e.cwrap("sqlite3_value_text",..._("n:s"));return function(t){return r(t)}}(),n.value_type=function(){const r=e.cwrap("sqlite3_value_type",..._("n:n"));return function(t){return r(t)}}(),n.vfs_register=function(s,r){const t=e.registerVFS(s,r);return d("sqlite3_vfs_register",t)};function d(s,r,t=null,c=[0]){if(c.includes(r))return r;const o=t?e.ccall("sqlite3_errmsg","string",["number"],[t]):s;throw new q(o,r)}return n}function _(e){const n=[],i=e.match(/([ns@]*):([nsv@])/);switch(i[2]){case"n":n.push("number");break;case"s":n.push("string");break;case"v":n.push(null);break}const h=[];for(let a of i[1])switch(a){case"n":h.push("number");break;case"s":h.push("string");break}return n.push(h),n}const $=Symbol("Comlink.proxy"),tn=Symbol("Comlink.endpoint"),en=Symbol("Comlink.releaseProxy"),D=Symbol("Comlink.finalizer"),C=Symbol("Comlink.thrown"),j=e=>typeof e=="object"&&e!==null||typeof e=="function",rn={canHandle:e=>j(e)&&e[$],serialize(e){const{port1:n,port2:i}=new MessageChannel;return H(e,n),[i,[i]]},deserialize(e){return e.start(),an(e)}},sn={canHandle:e=>j(e)&&C in e,serialize({value:e}){let n;return e instanceof Error?n={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:n={isError:!1,value:e},[n,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},X=new Map([["proxy",rn],["throw",sn]]);function cn(e,n){for(const i of e)if(n===i||i==="*"||i instanceof RegExp&&i.test(n))return!0;return!1}function H(e,n=globalThis,i=["*"]){n.addEventListener("message",function h(a){if(!a||!a.data)return;if(!cn(i,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:p,type:m,path:g}=Object.assign({path:[]},a.data),b=(a.data.argumentList||[]).map(O);let E;try{const f=g.slice(0,-1).reduce((y,T)=>y[T],e),l=g.reduce((y,T)=>y[T],e);switch(m){case"GET":E=l;break;case"SET":f[g.slice(-1)[0]]=O(a.data.value),E=!0;break;case"APPLY":E=l.apply(f,b);break;case"CONSTRUCT":{const y=new l(...b);E=A(y)}break;case"ENDPOINT":{const{port1:y,port2:T}=new MessageChannel;H(e,T),E=_n(y,[y])}break;case"RELEASE":E=void 0;break;default:return}}catch(f){E={value:f,[C]:0}}Promise.resolve(E).catch(f=>({value:f,[C]:0})).then(f=>{const[l,y]=B(f);n.postMessage(Object.assign(Object.assign({},l),{id:p}),y),m==="RELEASE"&&(n.removeEventListener("message",h),Y(n),D in e&&typeof e[D]=="function"&&e[D]())}).catch(f=>{const[l,y]=B({value:new TypeError("Unserializable return value"),[C]:0});n.postMessage(Object.assign(Object.assign({},l),{id:p}),y)})}),n.start&&n.start()}function on(e){return e.constructor.name==="MessagePort"}function Y(e){on(e)&&e.close()}function an(e,n){return W(e,[],n)}function k(e){if(e)throw new Error("Proxy has been released and is not useable")}function J(e){return x(e,{type:"RELEASE"}).then(()=>{Y(e)})}const U=new WeakMap,P="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const n=(U.get(e)||0)-1;U.set(e,n),n===0&&J(e)});function un(e,n){const i=(U.get(n)||0)+1;U.set(n,i),P&&P.register(e,n,e)}function fn(e){P&&P.unregister(e)}function W(e,n=[],i=function(){}){let h=!1;const a=new Proxy(i,{get(p,m){if(k(h),m===en)return()=>{fn(a),J(e),h=!0};if(m==="then"){if(n.length===0)return{then:()=>a};const g=x(e,{type:"GET",path:n.map(b=>b.toString())}).then(O);return g.then.bind(g)}return W(e,[...n,m])},set(p,m,g){k(h);const[b,E]=B(g);return x(e,{type:"SET",path:[...n,m].map(f=>f.toString()),value:b},E).then(O)},apply(p,m,g){k(h);const b=n[n.length-1];if(b===tn)return x(e,{type:"ENDPOINT"}).then(O);if(b==="bind")return W(e,n.slice(0,-1));const[E,f]=G(g);return x(e,{type:"APPLY",path:n.map(l=>l.toString()),argumentList:E},f).then(O)},construct(p,m){k(h);const[g,b]=G(m);return x(e,{type:"CONSTRUCT",path:n.map(E=>E.toString()),argumentList:g},b).then(O)}});return un(a,e),a}function ln(e){return Array.prototype.concat.apply([],e)}function G(e){const n=e.map(B);return[n.map(i=>i[0]),ln(n.map(i=>i[1]))]}const Z=new WeakMap;function _n(e,n){return Z.set(e,n),e}function A(e){return Object.assign(e,{[$]:!0})}function B(e){for(const[n,i]of X)if(i.canHandle(e)){const[h,a]=i.serialize(e);return[{type:"HANDLER",name:n,value:h},a]}return[{type:"RAW",value:e},Z.get(e)||[]]}function O(e){switch(e.type){case"HANDLER":return X.get(e.name).deserialize(e.value);case"RAW":return e.value}}function x(e,n,i){return new Promise(h=>{const a=hn();e.addEventListener("message",function p(m){!m.data||!m.data.id||m.data.id!==a||(e.removeEventListener("message",p),h(m.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:a},n),i)})}function hn(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const wn=new Error("request for lock canceled");var En=function(e,n,i,h){function a(p){return p instanceof i?p:new i(function(m){m(p)})}return new(i||(i=Promise))(function(p,m){function g(f){try{E(h.next(f))}catch(l){m(l)}}function b(f){try{E(h.throw(f))}catch(l){m(l)}}function E(f){f.done?p(f.value):a(f.value).then(g,b)}E((h=h.apply(e,n||[])).next())})};class mn{constructor(n,i=wn){this._value=n,this._cancelError=i,this._weightedQueues=[],this._weightedWaiters=[]}acquire(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise((i,h)=>{this._weightedQueues[n-1]||(this._weightedQueues[n-1]=[]),this._weightedQueues[n-1].push({resolve:i,reject:h}),this._dispatch()})}runExclusive(n,i=1){return En(this,void 0,void 0,function*(){const[h,a]=yield this.acquire(i);try{return yield n(h)}finally{a()}})}waitForUnlock(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise(i=>{this._weightedWaiters[n-1]||(this._weightedWaiters[n-1]=[]),this._weightedWaiters[n-1].push(i),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(n){this._value=n,this._dispatch()}release(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);this._value+=n,this._dispatch()}cancel(){this._weightedQueues.forEach(n=>n.forEach(i=>i.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var n;for(let i=this._value;i>0;i--){const h=(n=this._weightedQueues[i-1])===null||n===void 0?void 0:n.shift();if(!h)continue;const a=this._value,p=i;this._value-=i,i=this._value+1,h.resolve([a,this._newReleaser(p)])}this._drainUnlockWaiters()}_newReleaser(n){let i=!1;return()=>{i||(i=!0,this.release(n))}}_drainUnlockWaiters(){for(let n=this._value;n>0;n--)this._weightedWaiters[n-1]&&(this._weightedWaiters[n-1].forEach(i=>i()),this._weightedWaiters[n-1]=[])}}var pn=function(e,n,i,h){function a(p){return p instanceof i?p:new i(function(m){m(p)})}return new(i||(i=Promise))(function(p,m){function g(f){try{E(h.next(f))}catch(l){m(l)}}function b(f){try{E(h.throw(f))}catch(l){m(l)}}function E(f){f.done?p(f.value):a(f.value).then(g,b)}E((h=h.apply(e,n||[])).next())})};class gn{constructor(n){this._semaphore=new mn(1,n)}acquire(){return pn(this,void 0,void 0,function*(){const[,n]=yield this._semaphore.acquire();return n})}runExclusive(n){return this._semaphore.runExclusive(()=>n())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}let K=1;async function bn(e,n={useWebWorker:!0}){const{default:i}=await import("./wa-sqlite-async-BQPTkA7Y.js"),h=await i(),a=nn(h),{IDBBatchAtomicVFS:p}=await import("./IDBBatchAtomicVFS-CauzFwzw.js"),m=new p(e);a.vfs_register(m,!0);const g=await a.open_v2(e),b=new gn,E=new Map;a.register_table_onchange_hook(g,(s,r,t)=>{Array.from(E.values()).forEach(c=>c(s,r,t))});const f=async(s,r)=>l(async()=>y(s,r)),l=s=>b.runExclusive(s),y=async(s,r)=>{const t=[];for await(const u of a.statements(g,s)){let w;const S=r?[r]:[[]];for(const I of S){I.forEach((L,v,M)=>{typeof L=="boolean"&&(M[v]=L?1:0)}),a.reset(u),r&&a.bind_collection(u,I);const N=[];for(;await a.step(u)===100;){const L=a.row(u);N.push(L)}w=w??a.column_names(u),w.length&&t.push({columns:w,rows:N})}if(r)break}const c=[];for(const u of t)for(const w of u.rows){const S={};u.columns.forEach((I,N)=>{S[I]=w[N]}),c.push(S)}return{insertId:a.last_insert_id(g),rowsAffected:a.changes(g),rows:{_array:c,length:c.length}}},T=async(s,r)=>l(async()=>{let t=0;const c=a.str_new(g,s),o=a.str_value(c);try{await y("BEGIN TRANSACTION");const w=await a.prepare_v2(g,o);if(w===null)return{rowsAffected:0,rows:{_array:[],length:0}};const S=r||[];for(const I of S){for(let L=0;L<I.length;L++){const v=I[L];typeof v=="boolean"&&(I[L]=v?1:0)}a.reset(w.stmt),r&&a.bind_collection(w.stmt,I),await a.step(w.stmt)===101&&(t+=a.changes(g))}await a.finalize(w.stmt),await y("COMMIT")}catch{return await y("ROLLBACK"),{rowsAffected:0,rows:{_array:[],length:0}}}finally{a.str_finish(c)}return{rowsAffected:t,rows:{_array:[],length:0}}});if(n.useWebWorker){const s=r=>{const t=K++;return E.set(t,r),A(()=>{E.delete(t)})};return{execute:A(f),executeBatch:A(T),registerOnTableChange:A(s),close:A(()=>{a.close(g)})}}return{execute:f,executeBatch:T,registerOnTableChange:s=>{const r=K++;return E.set(r,s),()=>{E.delete(r)}},close:()=>a.close(g)}}const yn=self,R=new Map,Tn="open-wasqlite-db";let dn=1;const Sn=async e=>navigator.locks.request(Tn,async()=>{const n=dn++;if(!R.has(e)){const p=new Set,m=await bn(e);R.set(e,{clientIds:p,db:m})}const i=R.get(e);i.clientIds.add(n);const{db:h}=i,a={...h,close:A(()=>{const{clientIds:p}=i;if(p.delete(n),p.size==0)return console.debug(`Closing connection to ${e}.`),R.delete(e),h.close?.();console.debug(`Connection to ${e} not closed yet due to active clients.`)})};return A(a)});yn.onconnect=function(e){const n=e.ports[0];console.debug("Exposing db on port",n),H(Sn,n)};addEventListener("unload",()=>{Array.from(R.values()).forEach(async e=>{(await e.db).close?.()})})})();export{qn as S,In as a,An as b,On as c,kn as d,Ln as e,Qn as f,Un as g,Bn as h,Cn as i,Pn as j,Rn as k,Nn as l,vn as m,xn as n,Fn as o,Dn as p,Wn as q,Hn as r,__tla};